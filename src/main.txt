#include "encoder.h"
#include "motor.h"
#include "Arduino.h"
#include "ultrasound.h"
#include "line_tracker.h"

int speedA = 100;
int speedB = 100;
bool isBusy = false;


// int move = 60;

int threshold = 3800;

bool fwd = true;

int pos = 0;
int capteurs[5]={0,0,0,0,0};
int capteurs2[5]={0,0,0,0,0};

int memory[4][5]={{0,0,0,0,0},{0,0,0,0,0},{0,0,0,0,0},{0,0,0,0,0}};
int l_mem[5]={0,0,0,0,0};
int ligne_choisie[5]={0,0,0,0,0};


int ponderation_g[5] = {-3,-1,0,1,3};
int ponderation_d[5] = {3,1,0,-1,-3};

void acquisition(){
    capteurs[0]=Left2();
    capteurs[1]=Left1();
    capteurs[2]=Center();
    capteurs[3]=Right1();
    capteurs[4]=Right2();
    capteurs2[0]=Left2();
    capteurs2[1]=Left1();
    capteurs2[2]=Center();
    capteurs2[3]=Right1();
    capteurs2[4]=Right2();
}

void keep_memory(){
    for (int i=0; i<3; i++){
        for (int j=0; j<5;j++){
            memory[4-i][j] = memory[3-i][j];
        }
    }
    for (int i=0;i<5;i++){
        if(capteurs2[i]<threshold){
            memory[0][i] = 1;
        }
        else{
            memory[0][i] = 0;
        }
    }
}

void check_bureau(){
    if( capteurs[0]<threshold && capteurs[1]<threshold && capteurs[2]<threshold && capteurs[3]<threshold && capteurs[4]<threshold){
        pos+=1; 
    }
}

void chose_line(int tab[4][5], int n){
    for(int i=0;i<5;i++){
        ligne_choisie[i]=tab[n][i];
    }
}

int cal_d(int tab[5]){
    int res = 0;
    for(int i=0;i<5;i++){
        res+=tab[i]*ponderation_d[i];
    }
    return res;
}

int cal_g(int tab[5]){
    int res = 0;
    for(int i=0;i<5;i++){
        res+=tab[i]*ponderation_g[i];
    }
    return res;
}

void calcul_reg(int tab[4][5]){
    int tab0[5]={0,0,0,0,0};
    chose_line(tab,0);
    for(int i=0;i<5;i++){
        tab0[i]=ligne_choisie[i];
    }
    chose_line(tab,1);
    int tab1[5]={0,0,0,0,0};
    for(int i=0;i<5;i++){

        tab1[i]=ligne_choisie[i];
    }
    chose_line(tab,2);
    int tab2[5]={0,0,0,0,0};
    for(int i=0;i<5;i++){
        tab2[i]=ligne_choisie[i];
    }
    chose_line(tab,3);
    int tab3[5]={0,0,0,0,0};
    for(int i=0;i<5;i++){
        tab3[i]=ligne_choisie[i];
    }
    speedA = 140+20*cal_g(tab0)+8*cal_g(tab1)+2*cal_g(tab2)+1*cal_g(tab3);
    speedB = 140+20*cal_d(tab0)+8*cal_d(tab1)+2*cal_d(tab2)+1*cal_d(tab3);
}


void turn_left(){
    move_forward(0, speedB);
    double ticks_for_turn = 400;
    double  previous_ticks = Read_Right_ENC_CHAN_A();
    double  actual_ticks = Read_Right_ENC_CHAN_A();
    double ticks = 0;
   
   while (ticks < ticks_for_turn)
   {
    actual_ticks = Read_Right_ENC_CHAN_A();
    ticks = actual_ticks - previous_ticks;
    }
    stop_motors();
}

void turn_right(){
    move_forward(speedA, 0);
    double ticks_for_turn = 400;
    double previous_ticks = Read_Left_ENC_CHAN_A();
    double actual_ticks = Read_Left_ENC_CHAN_A();
    double ticks = 0;
    
    while (ticks < ticks_for_turn)
    {
        actual_ticks = Read_Left_ENC_CHAN_A();
        ticks = actual_ticks - previous_ticks;
        }
    stop_motors();
}



void move_regulation(){
    if ( capteurs[0]>threshold && capteurs[1]>threshold && capteurs[2]>threshold && capteurs[3]>threshold && capteurs[4]>threshold){
        stop_motors();
    }
    // On a atteint la destination
    /*else if( capteurs[0]<threshold && capteurs[1]<threshold && capteurs[2]<threshold && capteurs[3]<threshold && capteurs[4]<threshold && pos == dest){
        stop_motors();
        send_notif();
    }*/
    //move left
    else if ( capteurs[0]<threshold && capteurs[1]<threshold && capteurs[2]<threshold && capteurs[3]>threshold && capteurs[4]>threshold){
        turn_left();
    }
    //move right
    else if ( capteurs[0]>threshold && capteurs[1]>threshold && capteurs[2]<threshold && capteurs[3]<threshold && capteurs[4]<threshold){
        turn_right();
    }
    else if (memory[0][0]==1 || memory[0][1]==1 || memory[0][2]==1 || memory[0][3]==1 || memory[0][4]==1){
        move_forward(speedA,speedB);
    }
}

void setup() {
delay (500);
Serial.begin(115200);
Init_Encoders();
init_motors();
init_untrasounds();  
// move_forward(speedA, speedB);  
init_tracker();
}

void loop() {

    switch_ultrasounds();
    if((read_ultrasound1()<30)||(read_ultrasound2()<30)){
        stop_motors();
    }
    else{
    acquisition();
    keep_memory();
    Serial.println(capteurs[0]);
    Serial.println(capteurs[1]);
    Serial.println(capteurs[2]);
    Serial.println(capteurs[3]);
    Serial.println(capteurs[4]);
    check_bureau();
    calcul_reg(memory);
    Serial.print("new");
    move_regulation();
   }

    // turn_left();

    // delay(2000);
    // turn_right();

// display_tracker();
// move_left(speedA, speedB);

// move_left(speedA, speedB);

// switch_ultrasounds();
// if((read_ultrasound1()<30)||(read_ultrasound2()<30)){
//     stop_motors();
//    }
//    else{
//     // move_regulation();
//     move_forward(speedA, speedB);  
    
//    }

// display_distances();
// display_encoders();
// delay(200);
}